name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  package-and-publish:
    runs-on: ubuntu-latest
    env:
      VSCE_TOKEN: ${{ secrets.VSCE_TOKEN }}
      OVSX_TOKEN: ${{ secrets.OVSX_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies (root)
        run: npm ci

      - name: Install dependencies (extension)
        run: npm ci
        working-directory: extension

      - name: Build (extension)
        run: npm run build
        working-directory: extension

      - name: Clean previous VSIX artifacts
        run: |
          rm -f extension/*.vsix || true

      - name: Resolve VSIX filename
        run: |
          node -e 'const p=require("./extension/package.json"); const f = `${p.publisher}.${p.name}-${p.version}.vsix`; require("fs").appendFileSync(process.env.GITHUB_ENV, `VSIX_FILENAME=${f}\n`);'

      - name: Package VSIX
        run: npx vsce package --no-dependencies
        working-directory: extension

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ai-rule-hub-vsix
          path: extension/${{ env.VSIX_FILENAME }}

      - name: Ensure Open VSX namespace
        if: always() && env.OVSX_TOKEN != ''
        run: |
          npm i -g ovsx
          PUBLISHER=$(node -p "require('./extension/package.json').publisher")
          echo "Publisher: $PUBLISHER"
          ovsx create-namespace "$PUBLISHER" -p "$OVSX_TOKEN" || echo "Namespace exists or cannot be created; continuing"

      - name: Publish to VS Marketplace
        if: env.VSCE_TOKEN != ''
        continue-on-error: true
        run: npx vsce publish -p "$VSCE_TOKEN"
        working-directory: extension

      - name: Publish to Open VSX (optional)
        if: always() && env.OVSX_TOKEN != ''
        run: |
          npm i -g ovsx
          ovsx publish "extension/${{ env.VSIX_FILENAME }}" -p "$OVSX_TOKEN"
