name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  package-and-publish:
    runs-on: ubuntu-latest
    env:
      VSCE_TOKEN: ${{ secrets.VSCE_TOKEN }}
      OVSX_TOKEN: ${{ secrets.OVSX_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies (root)
        run: npm ci

      - name: Install dependencies (extension)
        run: npm ci
        working-directory: extension

      - name: Build (extension)
        run: npm run build
        working-directory: extension

      - name: Clean previous VSIX artifacts
        run: |
          rm -f extension/*.vsix || true

      - name: Package VSIX
        run: npx vsce package --no-dependencies
        working-directory: extension

      - name: Resolve built VSIX filepath
        run: |
          echo "VSIX_FILEPATH=$(ls -1 extension/*.vsix | head -n 1)" >> $GITHUB_ENV
          echo "Resolved VSIX_FILEPATH: $VSIX_FILEPATH"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ai-rule-hub-vsix
          path: ${{ env.VSIX_FILEPATH }}

      - name: Ensure Open VSX namespace
        if: always() && env.OVSX_TOKEN != ''
        run: |
          npm i -g ovsx
          PUBLISHER=$(node -p "require('./extension/package.json').publisher")
          echo "Publisher: $PUBLISHER"
          ovsx create-namespace "$PUBLISHER" -p "$OVSX_TOKEN" || echo "Namespace exists or cannot be created; continuing"

      - name: Publish to VS Marketplace
        if: env.VSCE_TOKEN != ''
        continue-on-error: true
        run: npx vsce publish -p "$VSCE_TOKEN"
        working-directory: extension

      - name: Publish to Open VSX (optional)
        if: always() && env.OVSX_TOKEN != ''
        run: |
          npm i -g ovsx
          echo "Publishing file: $VSIX_FILEPATH"
          ovsx publish "$VSIX_FILEPATH" -p "$OVSX_TOKEN"
